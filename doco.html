<!doctype html>
<head>
<title>Thunder - Doco</title>
<style>
body { margin: 0px auto; width: 1000px; font-family: Arial, sans-serif; font-size: 10pt; }
h2 { font-family: Georgia, serif; }
h3 { font-weight: normal; }
h3 span:first-child { color: blue; font-weight: bold; }

.Members, .Options, .Parms { list-style: none; padding-left: 10px; line-height: 20px; }

.Members { padding-left: 20px; }
.Members li { margin: 10px 0; padding: 0px 0 10px 0px; border-bottom: 1px solid #ddd; }
.Members li span { display: inline-block; width: 600px; }
.Members li span:first-child { color: blue; font-weight: bold;  width: 350px; vertical-align: top;}

.Parms   li { margin: 10px; padding: 0px 0 10px 19px; border-left: 1px solid #ddd; }
.Parms   li span { display: inline-block; width: 600px; }
.Parms   li span:first-child { color: #008888; width: 310px; }

.Parms .Parms li span { width: 350px; }
.Parms .Parms li span:first-child { width: 100px; }

.Options li { margin: 10px; padding: 0px 0 10px 19px; border-left: 1px solid #ddd; }
.Options li span { display: inline-block; width: 600px; }
.Options li span:first-child { color: green; width: 270px; }

</style>
</head>
<body>
<h1>Thunder</h1>

<h2>Welcome to Thunder!</h2>
    <p>Thunder is a JavaScript library that aims to make it easy to create and play sounds in your browser.  Here are some examples of what you can do:</p>
    <pre>
    //create waves using simple math
    var sineFunc(pos, len, freq) { 
        return Math.floor( Th.getMaxSample() * Math.sin( 2.0 * Math.PI * freq * pos /  Th.D_SAMPLE_RATE) );
    };
    Th.Sound.create( "A440Sine", sineFunc );
    
    //play the sounds you've created
    Th.Sound.get( "A440Sine" ).play();
    
    //create and play instruments based on the same math
    var sineInst=Th.Inst.create( "SimpleSine", sineFunc );
    sineInst.getSound( "A" ).play();
    sineInst.getSound( "B" ).play( 1 );    
    sineInst.getSound( "C2" ).play( 2 );        
    
    //play songs using RTTL
    var score="close encounters: d=4,o=3,b=120: d, e, c, p, c2., p, 2g2";
    Th.Sequence.create("CE Sine","SimpleSine",score).play();
    </pre>

<h2>Browser Support</h2>
    <p>Currently Thunder will work in any browser that supports the &lt;audio&gt; tag with uri data for the source and the .wav file format.  Right now this means at least these browsers will work:</p>
    <p><b>Known working browsers</b></p>
    <ul>
        <li>Chrome 12
        <li>Firefox 4
        <li>Safari 5 on Mac OSX
        <li>Opera 11
        </ul>
    <p><b>Known <em>not</em> working browsers</b></p>
    <ul>
        <li>IE 9 and less
        <li>Safari on iOS (iPhones and iPads)
        </ul>
    <p>Other browsers may or may not work, I don't know.  But I'd love any help getting certain browsers to work!</p>
    
<h2>Thunder API</h2>
    <p>Thus begins the documentation.</p>
    <p><em>Note 1: All UPPERCASE fields are to be treated as constants -- that is, do not try to modify them!</em></p>
    <p><em>Note 2: The D_ prefix is intended to mean "Default".  Eventually, there may be ways to change all or most of them.</em></p>
    
<h3><span>Th</span> <span>The root of Thunder</span></h3>
    <p>All Thunder functionality is reached through the Th namespace</p>
    <ul class="Members">
        <li><span>D_CHANNEL_COUNT  </span> <span>The default number of channels (2)</span></li>
        <li><span>D_SAMPLE_RATE    </span> <span>The default number of samples per second (44100)</span></li>
        <li><span>D_BITS_PER_SAMPLE</span> <span>The default number of bits per sample (16)</span></li>
        <li><span>D_TEMPO          </span> <span>The default tempo in beats per minute (100)</span></li>
        <li><span>D_A4FREQ         </span> <span>The default frequency of A4 (440)</span></li>
        <li><span>D_MIN_OCTAVE     </span> <span>The default minimum octave (0)</span></li>
        <li><span>D_MAX_OCTAVE     </span> <span>The default maximum octave (10)</span></li>
        <li><span>D_CENTER_OCTAVE  </span> <span>The default center octave (4)</span></li>
        <li><span>D_HALF_STEP_UP   </span> <span>The default ratio of frequency of a note to the note one half step lower </span></li>
        <li><span>D_HALF_STEP_DOWN </span> <span>The default ratio of frequency of a note to the note one half step higher </span></li>
        <li><span>D_MAX_SAMPLE_16  </span> <span>The default maximum sample value for 16 bit sound (32767)</span></li>
        <li><span>init([options])    </span> <span>Initializes Thunder setup.  This must be called before anything else.</span>
            <ul class="Parms">
                <li><span>options   </span> <span>An optional javascript object containing one or more of the following.</span>
                    <ul class="Options">
                        <li><span>tempo       </span> <span>Beats per minute as a number </span></li>
                        <li><span>beatSamples </span> <span>The number of samples (as in wave samples) per beat.  If present, it will override any tempo supplied.</span></li>
                        <li><span>a4Freq      </span> <span>The frequency (in Hz) of the A4 note </span></li>
                        <li><span>channelCount</span> <span>The number of channels (either 1 or 2) </span></li>
                        </ul>
                    </li>
                </ul>
            </li>
        <li><span>getMaxSample() number      </span> <span>Returns the maximum sample value</span></li>
        <li><span>getTempo() number          </span> <span>Returns the tempo of Thunder</span></li>
        <li><span>getBeatLength() number     </span> <span>Returns the length of Thunder as a ThDuration</span></li>
        <li><span>getAFrequency() number     </span> <span>Returns the current frequency of A4</span></li>
        <li><span>getChannelCount() number   </span> <span>Returns the number of channels currently being used (1 or 2).</span></li>
        <li><span>getFrequencyForNote(note) number </span> <span>Returns the frequency (in Hz) of a given note.  E.g. Th.getFrequencyForNote("A4") will return 440.</span>
            <ul class="Parms">
                <li><span>note               </span> <span>A string specifying a note in normal form.</span></li>
                </ul>
            </li>
        <li><span>getNoteForFrequency(freq) string </span> <span>Returns the note for a given frequency, if the frequency is within 0.5 of the "correct" value.  So Th.getNoteForFrequency(439.8) will return "A4".  The rounding is to allow for handling with compounded rounding issues.  However at high frequencies that may not be enough, and a better algorithm may end up being needed.</span>
            <ul class="Parms">
                <li><span>freq               </span> <span>A number reprezenting a Hz frequency.</span></li>
                </ul></li>
        <li><span>getOffsetNote(note,offset) string </span> <span>Returns a new note based on the given note and offset.  Th.offsetNote("A4",-5) will return "E3".</span>
            <ul class="Parms">
                <li><span>note               </span> <span>A string specifying a note in normal form.</span></li>
                <li><span>offset             </span> <span>A positive or negative number of halfsteps to offset the supplied note.</span></li>                
                </ul>
            </li>
        </ul>

<h3><span>Th.Sound</span> <span>The root for ThSound creation and retrieval.</span></h3>
    <p>Creates and manages all ThSound objects in Thunder.</p>
    <ul class="Members">
        <li><span>create([id,] ch1 [, ch2] [,options]) ThSound</span> <span>Returns a ThSound object based on the supplied arguments.</span>
            <ul class="Parms">
                <li><span>id                </span> <span>An optional ThSound identifier.</span></li>
                <li><span>ch1               </span> <span>A required channel array or function.  
                    <p>If ch1 is an array, it must be an array of Numbers between positive and negative Th.D_MAX_SAMPLE_16.  These will make up the samples of your ThSound.</p>
                    <p>If ch1 is a function, it will be passed four arguments:</p>
                    <ul class="Parms">
                        <li><span>index     </span><span>The sample position within the sound wave.</span></li>
                        <li><span>length    </span><span>The overall number of samples.</span></li>
                        <li><span>freq      </span><span>The frequency being used for this sound.</span></li>
                        <li><span>channel   </span><span>The current channel number. 1 for left or only and 2 for right.</span></li>
                        <li><span>options   </span><span>The options passed to the original sound creation.  Note that you can attach new variables to this object and it will be usable by the next call to the function.</span></li>
                        </ul>
                    </span>
                    </li>
                <li><span>ch2               </span> <span>An optional second channel array or function.  If not supplied in a two channel context, the left and right channel will be identical.</span></li>
                <li><span>options           </span> <span>Optional options for the ThSound creation.  </span>
                    <ul class="Options">
                        <li><span>duration  </span> <span>Either a ThDuration object or the number of beats for the sound.  The default will be one beat.</span></li>
                        <li><span>freq      </span> <span>The frequency of the sound.  The default will be A4's frequency, 440.</span></li>
                        <li><span>...       </span> <span>You can pass other values to the channel function via options.</span></li>
                        </ul>
                    </li>
                </ul>
            </li>
        <li><span>get(id) ThSound           </span> <span>Returns the specified ThSound.</span>
            <ul class="Parms">
                <li><span>id                </span> <span>The id of the ThSound to retrieve.</span></li>
                </ul></li>        
            </li>
        </ul>
        
<h3><span>ThSound</span> A ThSound object.</span></h3>
    <p>Contains and plays audio.</p>
    <ul class="Members">
        <li><span>getAudio() Audio       </span><span>Returns a normal HTML5 Audio element which contains the audio for this ThSound.</span></li>
        <li><span>getId() ThSound        </span><span>Returns the id of this ThSound.</span></li>
        <li><span>play([delayDuration])</span><span>Plays the ThSound either right away or after the specified delay.</span>
            <ul class="Parms">
                <li><span>delayDuration</span><span>How long to wait until this ThSound is played.</span></li>
                </ul>
            </li>
        <li><span>effect(name1 [, opt1] [, name2, opt2] ...) ThSound</span><span>Returns a ThSound that has the nominated effects applied.
            <p>The arguments for the effect function are an effect name, followed by the options for that effect, followed by more names and options if you like.  The available effects are:</p>
                    <ul class="List">
                        <li><span>speed</span>  <span>Increases or decreases the speed (which changes the length and pitch of the ThSound.  The option for this effect are numbers which specify the degree of speed increase/decrease.  For example, effect("speed",[.5,1,2]) will cause the sound to start out at half speed, increase to full speed, and then increase to double speed.</span></li>
                        <li><span>pitch</span>  <span>An alternative way of effecting the ThSound's speed, but uses pitches instead of relative speed values.   For example, effect("pitch","G3") or effect("pitch",[440,430]).  This implies that the ThSound was supplied a correct frequency when it was created.</span></li>
                        <li><span>volume</span> <span>Increases or decreases the volume of the ThSound.  For example, effect("volume",{0:0,0.1:2,.7:.5,1.0:0}) would produce a quick attack at double volume and then fade to nothing.</span></li>
                        <li><span>noise</span>  <span>Adds noise to the ThSound in proportion to the option provided.  effect("noise",0.1) will add quiet noise to the ThSound.</span></li>
                        <li><span>mix</span>    <span>The option must be another ThSound object or the id of one.  This ThSound is added to the original ThSound to create a new ThSound.</span></li>
                        <li><span>sample</span> <span>The option must be a function.  This function is passed several arguments including the position within the wave, and the sample value of this ThSound at that point.  The function is expected to return the sample value to be used at that point in the new ThSound.
                            <ul class="Parms">
                                <li><span>sample    </span><span>The sample value at that point in the sound wave.</span></li>                            
                                <li><span>index     </span><span>The sample position within the sound wave.</span></li>
                                <li><span>length    </span><span>The overall number of samples.</span></li>
                                <li><span>channel   </span><span>The current channel number. 1 for left or only and 2 for right.</span></li>
                                <li><span>options   </span><span>The options passed to the original sound creation.  Note that you can attach new variables to this object and it will be usable by the next call to the function.</span></li>
                                </ul>
                            </span></li>
                        </ul>
                </p>
            </span></li>
        </ul>
        

<h3><span>Th.Inst</span> <span>The root for ThInst creation and retrieval.</span></h3>
    <p>Creates and manages all ThInst objects in Thunder.</p>
    <ul class="Members">
        <li><span>create([id,], ch1 [, ch2] [, options ]) ThInst</span> <span>Returns a ThInst object based on the supplied arguments.</span>
            <ul class="Parms">
                <li><span>id                </span> <span>An optional ThInst identifier.</span></li>
                <li><span>ch1               </span> <span>A required channel function, which will be used to construct the seperate ThSounds that make up this instrument.</span>
                    </li>
                <li><span>ch2               </span> <span>An optional second channel array or function.  If not supplied in a two channel context, the left and right channel will be identical.</span></li>
                <li><span>options           </span> <span>Optional options for the ThInst creation, passed along to the ThSounds created internally.</span>
                    </li>
                </ul>
            </li>
        <li><span>get(id) ThInst            </span> <span>Returns the specified ThInst.</span>
            <ul class="Parms">
                <li><span>id                </span> <span>The id of the ThInst to retrieve.</span></li>
                </ul></li>        
            </li>
        </ul>        
        
        
<h3><span>ThInst</span> A ThInst object.</span></h3>
    <p>Creates and manages a Thunder Instrument, a set of related ThSounds with differing pitches, volumes, and other attributes.</p>
    <ul class="Members">
        <li><span>getSound(ptc [, opt]) ThSounds</span><span>Returns a ThSound object with the specified pitch and optional settings.</span></li>
        <li><span>getId() ThInst        </span><span>Returns the id of this ThInst.</span></li>
        </ul>        


<h3><span>Th.Sequence</span> <span>The root for ThSequence creation and retrieval.</span></h3>
    <p>Creates and manages all ThSequence objects in Thunder.</p>
    <ul class="Members">
        <li><span>create([id] , inst, [, notation] [, options ]) ThSequence</span> <span>Returns a ThSequence object based on the supplied arguments.</span>
            <ul class="Parms">
                <li><span>id                </span> <span>An optional ThSequence identifier.</span></li>
                <li><span>inst              </span> <span>A required ThInst object or id, or array of ThInst objects or ids, which is used to play the notation provided.</span>
                    </li>
                <li><span>notation          </span> <span>A string containing <a href="http://en.wikipedia.org/wiki/Ring_Tone_Transfer_Language">RTTL</a> based music notation, with some additional capabilities.</span>
                    <p>The string may begin with a name followed by a colon.  For example, "Rock and roll: " would mean the sequence name is "Rock and roll".
                    <p>The next portion is header portion ending in a colon.  The header contains a comma seperated list of key/value pairs, each seperated by an equal sign.  The keys that are allowed for the header are as follows:</p>
                    <ul class="Parms">
                        <li><span>D     </span><span>The default note duration.</span></li>
                        <li><span>O     </span><span>The default octave.</span></li>
                        <li><span>B     </span><span>The tempo, as beats per minute.</span></li>
                        <li><span>L     </span><span>How many times to loop (repeat).</span></li>
                        </ul>
                    <p>So if the header says "D=2, O=4, B=120, L=4: ", then this sequence will have a default not duration of a half note, will default to the fourth octave, will have a tempo of 120 beats per minute, and will repeat 4 times.</p>
                    <p>The rest of the string contains a comma/space seperated list of notes, chords, or controls.  Notes must start with a duration, followed by a music note specification, followed by an optional period, followed by the octave.  If the duration or octave are left off, the default applies.  For example "4d#5" will play a D sharp quarter note in the fifth octave.  The music note must begin with a letter A through G, and can be followed by a # or b to sharp or flat the note.  A note of "P" can be used for a pause.  Adding the period means it is a dotted note, and the duration is 1.5 times longer than otherwise specified, for example a "2B.2" would play a B in the second octave for 3 beats.</p>
                    <p>Chords are specified by surrounding a note with parenthesis with an optional suffix, or surrounding a of notes with parenthesis.  So "(G)" or "(Gj)" means to play a G major chord, whereas "(Gm)" will play a G minor chord.  Sets of notes like "(C Eb G Bb)" can be used to specify more complex chords (in this case Cm7).  The chord can be preceded by a duration and followed by an octave as with notes, for example "8(B#)2" would play a B sharp chord in the second octave for an eigth note.</p>
                    <p>Controls are one of the following keys combined with a number:</p>
                    <ul class="Parms">
                        <li><span>K     </span><span>Backtrack by the speficied number of beats, e.g. "4K" will reckon the next position to be a quarter note earlier.</span></li>
                        <li><span>R     </span><span>Realign to the next beat point for the specified duration.  "2R" will reckon the next position to be aligned to an even half note.</span></li>
                        <li><span>I     </span><span>Changes which instrument to use. "I1" would give you the second instrument spefied in the ThSequence constructor.</span></li>
                        </ul>                    
                    </li>
                <li><span>options           </span> <span>Optional options for the ThSequence creation, passed along to any ThSounds created internally.</span>
                    </li>
                </ul>
            </li>
        <li><span>get(id) ThSequence        </span> <span>Returns the specified ThSequence.</span>
            <ul class="Parms">
                <li><span>id                </span> <span>The id of the ThSequence to retrieve.</span></li>
                </ul></li>        
            </li>
        </ul>        
        
<h3><span>ThSequence</span> A ThSequence object.</span></h3>
    <p>Creates and manages a sequence of ThSounds.</p>
    <ul class="Members">
        <li><span>getName() string</span><span>Returns the name from the sequence notation.</span></li>
        <li><span>getId() string  </span><span>Returns the id of this ThSequence.</span></li>
        <li><span>play()          </span><span>Plays the ThSequence.</span></li>        
        </ul>        


